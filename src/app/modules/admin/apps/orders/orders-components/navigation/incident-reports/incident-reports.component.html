<ngx-skeleton-loader count="8" appearance="line" animation="pulse" *ngIf="isLoading">
</ngx-skeleton-loader>

<div class="row" *ngIf="!isLoading">
    <div class="col-12">
        <div>
            <mat-button-toggle-group #group="matButtonToggleGroup" [value]="mainScreen"
                (change)="calledScreen(group.value)">
                <mat-button-toggle value="Current Incident Reports">
                    Current Incident Reports
                </mat-button-toggle>
                <mat-button-toggle value="Create Incident Report">
                    Create Incident Report
                </mat-button-toggle>
            </mat-button-toggle-group>
        </div>
    </div>
    <div class="col-12" *ngIf="mainScreen == 'Current Incident Reports'">
        <div class="col-12 mt-2" *ngIf="!isView">
            <mat-card class="p-0 h-100 overflow-auto shadow-lg rounded-2xl">
                <mat-card-content>
                    <table mat-table [dataSource]="dataSource" class="w-full"
                        *ngIf="dataSource.length > 0; else noReports">

                        <!-- ID Column -->
                        <ng-container matColumnDef="id">
                            <th mat-header-cell *matHeaderCellDef class="min-w-10"> Id </th>
                            <td mat-cell *matCellDef="let transaction" class="text-sm" style="cursor: pointer;">
                                {{transaction.pk_incidentReportID}}
                            </td>
                        </ng-container>

                        <!-- ID Column -->
                        <ng-container matColumnDef="created">
                            <th mat-header-cell *matHeaderCellDef class="min-w-24"> Created </th>
                            <td mat-cell *matCellDef="let transaction" class="text-sm" style="cursor: pointer;">
                                {{transaction.date | date}}
                            </td>
                        </ng-container>

                        <!-- ID Column -->
                        <ng-container matColumnDef="created_by">
                            <th mat-header-cell *matHeaderCellDef class="min-w-24"> Created By </th>
                            <td mat-cell *matCellDef="let transaction" class="text-sm" style="cursor: pointer;">
                                {{transaction.storeUserFirstName + ' ' + transaction.storeUserLastName}}
                            </td>
                        </ng-container>

                        <!-- ID Column -->
                        <ng-container matColumnDef="store">
                            <th mat-header-cell *matHeaderCellDef class="min-w-50 w-50"> Store </th>
                            <td mat-cell *matCellDef="let transaction" class="text-sm" style="cursor: pointer;">
                                {{transaction.storeName}}
                            </td>
                        </ng-container>

                        <!-- ID Column -->
                        <ng-container matColumnDef="source">
                            <th mat-header-cell *matHeaderCellDef class="min-w-24"> Source </th>
                            <td mat-cell *matCellDef="let transaction" class="text-sm" style="cursor: pointer;">
                                {{transaction.sourceEntity}}
                            </td>
                        </ng-container>

                        <!-- ID Column -->
                        <ng-container matColumnDef="source_entities">
                            <th mat-header-cell *matHeaderCellDef class="min-w-50 w-50"> Source Entities </th>
                            <td mat-cell *matCellDef="let transaction" class="text-sm" style="cursor: pointer;">
                                <p>{{transaction.sourceEntity}}</p>
                                <p>{{transaction.sourceEmployeeName}}</p>
                            </td>
                        </ng-container>
                        <!-- Delete -->
                        <ng-container matColumnDef="action">
                            <th mat-header-cell *matHeaderCellDef class="min-w-15 w-15"> Action </th>
                            <td mat-cell *matCellDef="let transaction">
                                <div class="flex">
                                    <div>
                                        <mat-icon class="cursor-pointer " style="width: 20px;min-width:20px"
                                            [matTooltip]="'View'" svgIcon="mat_solid:remove_red_eye"
                                            (click)="viewIncidentReport(transaction)"></mat-icon>
                                    </div>
                                    <div>
                                        <mat-icon class="cursor-pointer text-lg" *ngIf="!transaction?.deleteLoader"
                                            [matTooltip]="'Delete'" (click)="deleteIncidentReport(transaction)">delete
                                        </mat-icon>
                                        <mat-progress-spinner class="text-lg" *ngIf="transaction?.deleteLoader"
                                            [diameter]="24" [mode]="'indeterminate'">
                                        </mat-progress-spinner>
                                    </div>
                                </div>
                            </td>
                        </ng-container>

                        <tr mat-header-row *matHeaderRowDef="displayedColumns" class="h-18 bg-light"></tr>
                        <tr mat-row *matRowDef="let row; columns: displayedColumns;"
                            class="h-12 hover:bg-gray-100 dark:hover:bg-hover"></tr>
                    </table>
                </mat-card-content>
            </mat-card>
        </div>
        <div class="col-12 mt-2" *ngIf="isView">
            <!-- Header -->
            <div
                class="relative bg-light flex flex-col sm:flex-row flex-0 sm:items-center sm:justify-between md:px-8 border-b pb-2">

                <!-- Title -->
                <div class="text-1xl font-semibold">View Order # {{selectedOrder.pk_orderID}}</div>
                <!-- Actions -->
                <div class="flex flex-shrink-0 items-center mt-8 sm:mt-0 sm:ml-4">
                    <!-- Back to Incident Reports page button -->
                    <button [matTooltip]="'Go to Incident reports list'" class="ml-4" mat-stroked-button
                        [color]="'primary'" (click)="viewIncidentReport()">
                        <mat-icon [svgIcon]="'heroicons_outline:arrow-narrow-left'"></mat-icon>
                        <span class="ml-2 mr-1">Back to Incident Reports</span>
                    </button>
                </div>
            </div>
            <div class="row w-full mt-5">
                <mat-card class="w-full px-5 py-5 h-auto overflow-auto">
                    <mat-card-content>
                        <div class="row border-b font-bold">
                            <div class="col-6 text-left text-lg">
                                Update Incident Report
                            </div>
                            <div class="col-6 text-right text-secondary">
                                Order # 56160
                            </div>
                        </div>
                        <div class="row py-2">
                            <div class="col-lg-6 col-md-6 col-12">
                                <span class="font-semibold">Date</span>
                                <span class="float-right">{{todayDate}}</span>
                            </div>
                            <div class="col-lg-6 col-md-6 col-12">
                                <span class="font-semibold">Customer</span>
                                <span class="float-right">{{orderDetail.billingFirstName}}
                                    {{orderDetail.billingLastName}} from
                                    {{selectedOrder?.billingCompanyName}}</span>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-lg-6 col-md-6 col-12">
                                <span class="font-semibold">Program/Market</span>
                                <span class="float-right">{{selectedOrder.storeName}}</span>
                            </div>
                            <div class="col-lg-6 col-md-6 col-12">
                                <span class="font-semibold">Supplier(s) On Order</span>
                                <div class="float-right">
                                    <p *ngFor="let item of supplierList">{{item?.name}}</p>
                                </div>
                            </div>
                        </div>
                        <div class="row py-3 border-b"></div>
                        <div class="row pt-2 font-semibold">
                            <div class="col-12">
                                Incident Priority:
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-lg-6 col-md-6 col-12">
                                <small class="text-secondary font-semibold">Was customer service
                                    compromised/effected?</small>
                                <mat-form-field class="w-full">
                                    <mat-select [(ngModel)]="updateFormModal.priority1">
                                        <mat-option value="Yes">Yes</mat-option>
                                        <mat-option value="No">No</mat-option>
                                        <mat-option value="TBD">TBD</mat-option>
                                    </mat-select>
                                </mat-form-field>
                            </div>
                            <div class="col-lg-6 col-md-6 col-12">
                                <small class="text-secondary font-semibold">Did we lose money on this order
                                    in order to correct it?</small>
                                <mat-form-field class="w-full h-12">
                                    <mat-select [(ngModel)]="updateFormModal.priority3">
                                        <mat-option value="Yes">Yes</mat-option>
                                        <mat-option value="No">No</mat-option>
                                        <mat-option value="TBD">TBD</mat-option>
                                    </mat-select>
                                </mat-form-field>
                            </div>
                        </div>
                        <div class="row pt-2 font-semibold">
                            <div class="col-12">
                                Source of Incident:
                            </div>
                        </div>
                        <div class="row" *ngIf="reportSources">
                            <div class="col-lg-4 col-md-6 col-6" *ngFor="let item of reportSources">
                                <mat-checkbox (change)="updateAndRemoveFromCheckBox($event, item)"
                                    [(ngModel)]="item.checked">{{item.sourceName}}
                                </mat-checkbox>
                            </div>
                        </div>
                        <div class="row" *ngIf="employeeSource">
                            <div class="col-12">
                                <small class="text-secondary font-semibold">Source of Incident Employee</small>
                                <mat-form-field class="w-full">
                                    <input type="text" placeholder="Search User" matInput [formControl]="users"
                                        [matAutocomplete]="auto">
                                    <mat-autocomplete #auto="matAutocomplete">
                                        <mat-option *ngIf="isUserLoader" class="is-loading">Loading...
                                        </mat-option>
                                        <ng-container *ngIf="!isUserLoader">
                                            <mat-option *ngFor="let result of usersList"
                                                (click)="updateuserSelected(result)"
                                                [value]="result.firstName + ' ' + result.lastName">
                                                {{result.firstName}} {{ result.lastName }}
                                            </mat-option>
                                        </ng-container>
                                    </mat-autocomplete>
                                </mat-form-field>
                            </div>
                        </div>
                        <div class="row" *ngIf="supplierSource">
                            <div class="col-12">
                                <small class="text-secondary font-semibold">Source of Incident Supplier</small>
                                <mat-form-field class="w-full">
                                    <mat-select matInput [(ngModel)]="updateFormModal.source_supplier">
                                        <mat-option *ngFor="let item of supplierList" [value]="item.id">{{item.name}}
                                        </mat-option>
                                    </mat-select>
                                </mat-form-field>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-12">
                                <span class="font-semibold">Money lost:</span>
                                <mat-form-field appearance="outline" class="w-full">
                                    <input matInput type="number" [(ngModel)]="updateFormModal.rerunCost">
                                    <mat-icon matSuffix svgIcon="heroicons_outline:currency-dollar"></mat-icon>
                                </mat-form-field>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-12">
                                <p class="font-semibold">Corrected to satisfaction of customer?</p>
                                <mat-form-field class="w-full h-12">
                                    <mat-select [(ngModel)]="updateFormModal.corrected" name="order">
                                        <mat-option value="Yes">Yes</mat-option>
                                        <mat-option value="No">No</mat-option>
                                        <mat-option value="TBD">TBD</mat-option>
                                    </mat-select>
                                </mat-form-field>
                            </div>
                        </div>
                        <div class="row pt-2">
                            <div class="col-lg-6 col-md-6 col-12">
                                <p class="font-semibold"> Explanation </p>
                                <mat-form-field class="w-full">
                                    <textarea [(ngModel)]="updateFormModal.explanation" matInput rows="5"></textarea>
                                </mat-form-field>
                            </div>
                            <div class="col-lg-6 col-md-6 col-12">
                                <p class="font-semibold"> How? </p>
                                <mat-form-field class="w-full">
                                    <textarea [(ngModel)]="updateFormModal.how" matInput rows="5"></textarea>
                                </mat-form-field>
                            </div>
                        </div>
                        <div class="row pt-2">
                            <div class="col-12">
                                <p class="font-semibold"> How do you recommend we prevent this from happening again in
                                    the
                                    future? </p>
                                <mat-form-field class="w-full">
                                    <textarea [(ngModel)]="updateFormModal.recommend" matInput rows="5"></textarea>
                                </mat-form-field>
                            </div>
                        </div>
                        <div class="row py-3 border-b"></div>
                        <div class="row py-2 px-5 float-right">

                            <button [disabled]="isUpdateLoader" class="min-w-50" mat-stroked-button
                                [matTooltip]="'Update Incident Report'" (click)="updateIncident()">
                                <mat-progress-spinner *ngIf="isUpdateLoader" [diameter]="24" [mode]="'indeterminate'"
                                    class="mr-2 mt-2"></mat-progress-spinner>
                                <mat-icon svgIcon="mat_outline:edit" *ngIf="!isUpdateLoader"></mat-icon>
                                <span class="ml-2" *ngIf="!isUpdateLoader"> Update Report </span>
                            </button>
                        </div>
                    </mat-card-content>
                </mat-card>
            </div>
        </div>
        <ng-template #noReports>
            <div class="p-8 sm:p-16 text-2xl font-semibold not-found-color">
                <!-- <img src="assets/gifs/not-found.gif" class="rounded-circle" style="width: 250px;"> -->
                No Incident Reports found!
            </div>
        </ng-template>
    </div>
    <div class="col-12 px-5 my-2" *ngIf="mainScreen == 'Create Incident Report'">
        <mat-card class="w-full px-5 py-5 h-auto overflow-auto">
            <mat-card-content>
                <div class="row border-b font-bold">
                    <div class="col-6 text-left text-lg">
                        Create Incident Report
                    </div>
                    <div class="col-6 text-right text-secondary">
                        Order # {{selectedOrder.pk_orderID}}
                    </div>
                </div>
                <div class="row py-2">
                    <div class="col-lg-6 col-md-6 col-12">
                        <span class="font-semibold">Date</span>
                        <span class="float-right">{{todayDate}}</span>
                    </div>
                    <div class="col-lg-6 col-md-6 col-12">
                        <span class="font-semibold">Customer</span>
                        <span class="float-right">{{orderDetail.billingFirstName}} {{orderDetail.billingLastName}} from
                            {{selectedOrder?.billingCompanyName}}</span>
                    </div>
                </div>
                <div class="row">
                    <div class="col-lg-6 col-md-6 col-12">
                        <span class="font-semibold">Program/Market</span>
                        <span class="float-right">{{selectedOrder.storeName}}</span>
                    </div>
                    <div class="col-lg-6 col-md-6 col-12">
                        <span class="font-semibold">Supplier(s) On Order</span>
                        <div class="float-right">
                            <p *ngFor="let item of supplierList">{{item?.name}}</p>
                        </div>
                    </div>
                </div>
                <div class="row py-3 border-b"></div>
                <div class="row pt-2 font-semibold">
                    <div class="col-12">
                        Incident Priority:
                    </div>
                </div>
                <div class="row">
                    <div class="col-lg-6 col-md-6 col-12">
                        <small class="text-secondary font-semibold">Was customer service
                            compromised/effected?</small>
                        <mat-form-field class="w-full">
                            <mat-select [(ngModel)]="formModal.priority1">
                                <mat-option value="Yes">Yes</mat-option>
                                <mat-option value="No">No</mat-option>
                                <mat-option value="TBD">TBD</mat-option>
                            </mat-select>
                        </mat-form-field>
                    </div>
                    <div class="col-lg-6 col-md-6 col-12">
                        <small class="text-secondary font-semibold">Did we lose money on this order
                            in order to correct it?</small>
                        <mat-form-field class="w-full h-12">
                            <mat-select [(ngModel)]="formModal.priority3">
                                <mat-option value="Yes">Yes</mat-option>
                                <mat-option value="No">No</mat-option>
                                <mat-option value="TBD">TBD</mat-option>
                            </mat-select>
                        </mat-form-field>
                    </div>
                </div>
                <div class="row pt-2 font-semibold">
                    <div class="col-12">
                        Source of Incident:
                    </div>
                </div>
                <div class="row" *ngIf="reportSources">
                    <div class="col-lg-4 col-md-6 col-6" *ngFor="let item of reportSources">
                        <mat-checkbox (change)="addAndRemoveFromCheckBox($event, item)">{{item.sourceName}}
                        </mat-checkbox>
                    </div>
                </div>
                <div class="row" *ngIf="employeeSource">
                    <div class="col-12">
                        <small class="text-secondary font-semibold">Source of Incident Employee</small>
                        <mat-form-field class="w-full">
                            <input type="text" placeholder="Search User" matInput [formControl]="users"
                                [matAutocomplete]="auto">
                            <mat-autocomplete #auto="matAutocomplete">
                                <mat-option *ngIf="isUserLoader" class="is-loading">Loading...
                                </mat-option>
                                <ng-container *ngIf="!isUserLoader">
                                    <mat-option *ngFor="let result of usersList" (click)="userSelected(result)"
                                        [value]="result.firstName + ' ' + result.lastName">
                                        {{result.firstName}} {{ result.lastName }}
                                    </mat-option>
                                </ng-container>
                            </mat-autocomplete>
                        </mat-form-field>
                    </div>
                </div>
                <div class="row" *ngIf="supplierSource">
                    <div class="col-12">
                        <small class="text-secondary font-semibold">Source of Incident Supplier</small>
                        <mat-form-field class="w-full">
                            <mat-select matInput [(ngModel)]="formModal.source_supplier">
                                <mat-option *ngFor="let item of supplierList" [value]="item.id">{{item.name}}
                                </mat-option>
                            </mat-select>
                        </mat-form-field>
                    </div>
                </div>
                <div class="row">
                    <div class="col-12">
                        <span class="font-semibold">Money lost:</span>
                        <mat-form-field appearance="outline" class="w-full">
                            <input matInput type="number" [(ngModel)]="formModal.rerunCost">
                            <mat-icon matSuffix svgIcon="heroicons_outline:currency-dollar"></mat-icon>
                        </mat-form-field>
                    </div>
                </div>
                <div class="row">
                    <div class="col-12">
                        <p class="font-semibold">Corrected to satisfaction of customer?</p>
                        <mat-form-field class="w-full h-12">
                            <mat-select [(ngModel)]="formModal.corrected" name="order">
                                <mat-option value="Yes">Yes</mat-option>
                                <mat-option value="No">No</mat-option>
                                <mat-option value="TBD">TBD</mat-option>
                            </mat-select>
                        </mat-form-field>
                    </div>
                </div>
                <div class="row pt-2">
                    <div class="col-lg-6 col-md-6 col-12">
                        <p class="font-semibold"> Explanation </p>
                        <mat-form-field class="w-full">
                            <textarea [(ngModel)]="formModal.explanation" matInput rows="5"></textarea>
                        </mat-form-field>
                    </div>
                    <div class="col-lg-6 col-md-6 col-12">
                        <p class="font-semibold"> How? </p>
                        <mat-form-field class="w-full">
                            <textarea [(ngModel)]="formModal.how" matInput rows="5"></textarea>
                        </mat-form-field>
                    </div>
                </div>
                <div class="row pt-2">
                    <div class="col-12">
                        <p class="font-semibold"> How do you recommend we prevent this from happening again in the
                            future? </p>
                        <mat-form-field class="w-full">
                            <textarea [(ngModel)]="formModal.recommend" matInput rows="5"></textarea>
                        </mat-form-field>
                    </div>
                </div>
                <div class="row py-3 border-b"></div>
                <div class="row py-2 px-5 float-right">

                    <button [disabled]="isIncidentLoader" class="min-w-50" mat-stroked-button
                        [matTooltip]="'Submit Incident Report'" (click)="CreateIncidentReport()">
                        <mat-icon svgIcon="heroicons_solid:plus" *ngIf="!isIncidentLoader"></mat-icon>
                        <span class="ml-2" *ngIf="!isIncidentLoader"> Submit Report </span>
                        <mat-progress-spinner *ngIf="isIncidentLoader" [diameter]="24" [mode]="'indeterminate'"
                            class="mr-2 mt-2"></mat-progress-spinner>
                    </button>
                </div>
            </mat-card-content>
        </mat-card>
    </div>
</div>